<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wangqin.mapper.ReceiptMapper">

	<!-- 通用查询结果列-->
    <sql id="Base_Column_List">
		 T1.id,T1.task_daily_id AS taskDailyId,T1.receipt_no AS receiptNo,T1.total_price AS totalPrice,T1.gmt_create AS gmtCreate,T1.gmt_modify AS gmtModify,T1.purchase_storage_id AS purchaseStorageId,T1.status,T1.buyer_id AS buyerId
	</sql>

	<select id="queryReceiptCount" resultType="java.lang.Integer"  parameterType="com.wangqin.vo.ReceiptQueryVO">
	 SELECT COUNT(*) FROM (SELECT
        	T1.`task_daily_id`
        FROM
            `receipt` T1 
              LEFT JOIN task_receipt T2 ON T1.id=T2.`receipt_id` 
        <where>
            <if test="receiptNo!=null and receiptNo!=''">
             	and T1.receipt_no = #{receiptNo} 
            </if>
            <if test=" startGmtCreate!= null ">
             and   <![CDATA[ T1.gmt_create >= #{startGmtCreate} ]]>
            </if>
            <if test=" endGmtCreate != null ">
            and    <![CDATA[ T1.gmt_create <= #{endGmtCreate} ]]>
            </if>
        </where>
          GROUP BY T1.`task_daily_id`,T1.`batch_num`) temp;
    </select>
    
    <select id="queryReceipt" resultType="com.wangqin.model.purchase.Receipt" parameterType="com.wangqin.vo.ReceiptQueryVO">
        SELECT
        	T1.`task_daily_id`,MAX(T3.task_title) as taskTitle, MAX(T1.id) as id, MAX(T1.`receipt_no`) as receiptNo ,MAX(T1.`gmt_create`) as gmtCreate,SUM(T2.`quantity`) as quantity,SUM(T2.`trans_quantity`) as transQuantity,SUM(T2.`quantity`*T2.`price`) as totalPrice,SUM(T2.`trans_quantity`*T2.`price`) as transTotalPrice
        FROM 
            `receipt` T1 
            LEFT JOIN task_receipt T2 ON T1.id=T2.`receipt_id`
            left join task_daily T3 on T1.task_daily_id=T3.id
        <where>
            <if test="receiptNo!=null and receiptNo!=''">
             	and T1.receipt_no = #{receiptNo} 
            </if>
            <if test=" startGmtCreate!= null ">
             and   <![CDATA[ T1.gmt_create >= #{startGmtCreate} ]]>
            </if>
            <if test=" endGmtCreate != null ">
            and    <![CDATA[ T1.gmt_create <= #{endGmtCreate} ]]>
            </if>
        </where>
         GROUP BY T1.`task_daily_id`,T1.`batch_num`
         ORDER BY id desc 
          	<![CDATA[ LIMIT #{firstStart},#{pageSize} ]]>
    </select>
</mapper>