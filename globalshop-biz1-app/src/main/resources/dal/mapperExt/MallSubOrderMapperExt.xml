<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wangqin.globalshop.biz1.app.dal.mapperExt.MallSubOrderMapperExt">
    <!-- 通用查询结果列-->
    <resultMap id="BaseResultMap" type="com.wangqin.globalshop.biz1.app.dal.dataObject.MallSubOrderDO" >
        <id column="id" property="id" jdbcType="BIGINT" />
        <result column="order_no" property="orderNo" jdbcType="VARCHAR" />
        <result column="mall_return_order_no" property="mallReturnOrderNo" jdbcType="VARCHAR" />
        <result column="customer_no" property="customerNo" jdbcType="VARCHAR" />
        <result column="open_id" property="openId" jdbcType="VARCHAR" />
        <result column="company_no" property="companyNo" jdbcType="VARCHAR" />
        <result column="shop_code" property="shopCode" jdbcType="VARCHAR" />
        <result column="channel_order_no" property="channelOrderNo" jdbcType="VARCHAR" />
        <result column="order_time" property="orderTime" jdbcType="TIMESTAMP" />
        <result column="item_code" property="itemCode" jdbcType="VARCHAR" />
        <result column="item_name" property="itemName" jdbcType="VARCHAR" />
        <result column="sku_code" property="skuCode" jdbcType="VARCHAR" />
        <result column="channel_sku_code" property="channelSkuCode" jdbcType="VARCHAR" />
        <result column="upc" property="upc" jdbcType="VARCHAR" />
        <result column="scale" property="scale" jdbcType="VARCHAR" />
        <result column="sku_pic" property="skuPic" jdbcType="VARCHAR" />
        <result column="logistic_type" property="logisticType" jdbcType="TINYINT" />
        <result column="freight" property="freight" jdbcType="DOUBLE" />
        <result column="freight_real" property="freightReal" jdbcType="DOUBLE" />
        <result column="weight" property="weight" jdbcType="DOUBLE" />
        <result column="sale_price" property="salePrice" jdbcType="DOUBLE" />
        <result column="sale_price_agent" property="salePriceAgent" jdbcType="DOUBLE" />
        <result column="quantity" property="quantity" jdbcType="INTEGER" />
        <result column="status" property="status" jdbcType="TINYINT" />
        <result column="close_reason" property="closeReason" jdbcType="VARCHAR" />
        <result column="warehouse_no" property="warehouseNo" jdbcType="VARCHAR" />
        <result column="stock_status" property="stockStatus" jdbcType="TINYINT" />
        <result column="shipping_order_no" property="shippingOrderNo" jdbcType="VARCHAR" />
        <result column="shipping_no" property="shippingNo" jdbcType="VARCHAR" />
        <result column="receiver" property="receiver" jdbcType="VARCHAR" />
        <result column="receiver_country" property="receiverCountry" jdbcType="VARCHAR" />
        <result column="receiver_state" property="receiverState" jdbcType="VARCHAR" />
        <result column="receiver_city" property="receiverCity" jdbcType="VARCHAR" />
        <result column="receiver_district" property="receiverDistrict" jdbcType="VARCHAR" />
        <result column="receiver_address" property="receiverAddress" jdbcType="VARCHAR" />
        <result column="telephone" property="telephone" jdbcType="VARCHAR" />
        <result column="postcode" property="postcode" jdbcType="VARCHAR" />
        <result column="id_card" property="idCard" jdbcType="VARCHAR" />
        <result column="idcard_pic_front" property="idcardPicFront" jdbcType="VARCHAR" />
        <result column="idcard_pic_reverse" property="idcardPicReverse" jdbcType="VARCHAR" />
        <result column="memo" property="memo" jdbcType="VARCHAR" />
        <result column="gmt_create" property="gmtCreate" jdbcType="TIMESTAMP" />
        <result column="gmt_modify" property="gmtModify" jdbcType="TIMESTAMP" />
        <result column="creator" property="creator" jdbcType="VARCHAR" />
        <result column="modifier" property="modifier" jdbcType="VARCHAR" />
        <result column="is_del" property="isDel" jdbcType="BIT" />
    </resultMap>
    <sql id="Base_Column_List" >
        id, order_no, mall_return_order_no, customer_no, open_id, company_no, shop_code,
        channel_order_no, order_time, item_code, item_name, sku_code, channel_sku_code, upc,
        scale, sku_pic, logistic_type, freight, freight_real, weight, sale_price, sale_price_agent,
        quantity, status, close_reason, warehouse_no, stock_status, shipping_order_no, shipping_no,
        receiver, receiver_country, receiver_state, receiver_city, receiver_district, receiver_address,
        telephone, postcode, id_card, idcard_pic_front, idcard_pic_reverse, memo, gmt_create,
        gmt_modify, creator, modifier, is_del
    </sql>
    <update id="updateOuterOrderDetailByItemSku">
        UPDATE mall_sub_order a
        LEFT JOIN item_sku b ON a.sku_code=b.sku_code
        SET
        a.item_code=b.item_code,a.sku_code=b.sku_code,a.upc=b.upc,a.weight=b.weight,a.item_name=b.item_name,a.sku_pic=b.sku_pic,a.logistic_type=b.logistic_type
        WHERE a.channel_order_no IN
        <foreach item="item" index="index" collection="erpOrderIdList" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <select id="selectOuterOrderDetailByOuterOrderId"
            resultType="com.wangqin.globalshop.biz1.app.dal.dataObject.MallSubOrderDO" parameterType="java.lang.Long">
        SELECT
        <include refid="Base_Column_List"/>
        FROM `outer_order_detail` T1 WHERE T1.outer_order_id=#{outerOrderId}
    </select>

    <update id="updateUpcForOuterOrderDetail"
            parameterType="com.wangqin.globalshop.biz1.app.dal.dataObject.MallOrderDO">
		UPDATE mall_sub_order SET upc=#{upc} WHERE (upc!=#{upc} or upc is null) and sku_code=#{skuCode}
    </update>

    <update id="updateWeightForOuterOrderDetail"
            parameterType="com.wangqin.globalshop.biz1.app.dal.dataObject.MallOrderDO">
		UPDATE mall_sub_order SET weight=#{weight} WHERE (weight!=#{weight} or weight is null) and sku_code=#{skuCode}
    </update>
    <select id="queryByOrderId" resultMap="BaseResultMap">
        SELECT
        id,
        company_no,
        order_no,
        sku_code,
        upc,
        item_name,
        stock_status,
        scale,
        channel_sku_code,
        receiver,
        telephone,
        postcode,
        memo,
        receiver_address,
        receiver_state,
        receiver_city,
        receiver_district,
        id_card,
        sale_price,
        weight,
        quantity,
        warehouse_no,
        order_time,
        sku_pic,
        logistic_type
        FROM
        mall_sub_order
        WHERE
        id IN
        <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
    <select id="selectPositionNoByOrderId" resultType="java.lang.String" parameterType="java.lang.String">
      SELECT group_concat(CONCAT(position_no, ':', booked_quantity))
            FROM inventory_booking_record
            WHERE order_no = #{orderNo}
    </select>
    <select id="selectCount" resultType="java.lang.Integer" parameterType="com.wangqin.globalshop.biz1.app.dal.dataObject.MallOrderDO">
        SELECT COUNT(*) FROM mall_sub_order WHERE order_no = #{orderNo};
    </select>
    <select id="findAlreadyShipped" resultType="java.lang.Integer" parameterType="com.wangqin.globalshop.biz1.app.dal.dataObject.MallOrderDO">
        SELECT COUNT(*) FROM mall_sub_order WHERE order_no = #{orderNo} AND  (status ='0' OR status='3');
    </select>
    <select id="selectByOrderNo" resultMap="BaseResultMap" parameterType="java.lang.String">
        SELECT * FROM mall_sub_order WHERE order_no = #{orderNo} ;
    </select>
    <select id="selectUnClosedByOrderNo" resultMap="BaseResultMap" parameterType="java.lang.String">
        SELECT * FROM mall_sub_order WHERE order_no = #{orderNo} AND status != '-1';
    </select>
    <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long">
        SELECT * FROM mall_sub_order WHERE id = #{id};
    </select>
    <select id="SelectByOrderNo" resultMap="BaseResultMap" parameterType="java.lang.String">
        SELECT * FROM mall_sub_order WHERE order_no = #{orderNo};
    </select>

    <select id="queryErpOrdersCount" resultType="java.lang.Integer"  parameterType="com.wangqin.globalshop.biz1.app.dal.dataVo.MallSubOrderVO">
        SELECT
        count(1)
        FROM
        `mall_sub_order`
        <where>
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="stockStatus != null">
                and stock_status = #{stockStatus}
            </if>
            <if test="orderNo != null">
                and order_no LIKE concat('%',#{orderNo},'%')
            </if>
            <if test="upc != null">
                and upc = #{upc}
            </if>
            <if test="skuCode!=null and skuCode!=''">
                and sku_code = #{skuCode}
            </if>
            <if test="openId!=null and openId!='' and salesId==null">
                and open_id = #{openId}
            </if>
            <if test="itemName!=null and itemName!=''">
                and item_name LIKE concat('%',#{itemName},'%')
            </if>
            <if test="receiver!=null and receiver!=''">
                and receiver LIKE concat('%',#{receiver},'%')
            </if>
            <if test="telephone!=null and telephone!=''">
                and telephone = #{telephone}
            </if>
            <if test="warehouseNo!=null and warehouseNo!=''">
                and warehouse_no = #{warehouseNo}
            </if>
            <if test="logisticType!=null and logisticType!=''">
                and logistic_type = #{logisticType}
            </if>
            <if test="closeReason!=null and closeReason!=''">
                and close_reason = #{closeReason}
            </if>

            <if test=" startGmtCreate!= null ">
                and   <![CDATA[ gmt_create >= #{startGmtCreate} ]]>
            </if>
            <if test=" endGmtCreate != null ">
                and    <![CDATA[ gmt_create <= #{endGmtCreate} ]]>
            </if>
            <if test = "companyNo != null">
                and company_no = #{companyNo}
            </if>
        </where>
    </select>
    <select id="queryErpOrders" resultMap="BaseResultMap"  parameterType="com.wangqin.globalshop.biz1.app.dal.dataVo.MallSubOrderVO">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        `mall_sub_order`
        <where>
            <if test="status != null">
            and status = #{status}
            </if>
            <if test="stockStatus != null">
                and stock_status = #{stockStatus}
            </if>
            <if test="orderNo != null">
            and order_no LIKE concat('%',#{orderNo},'%')
            </if>
            <if test="upc != null">
            and upc = #{upc}
            </if>
            <if test="skuCode!=null and skuCode!=''">
                and sku_code = #{skuCode}
            </if>
            <if test="openId!=null and openId!='' and salesId==null">
                and open_id = #{openId}
            </if>
            <if test="itemName!=null and itemName!=''">
                and item_name LIKE concat('%',#{itemName},'%')
            </if>
            <if test="receiver!=null and receiver!=''">
                and receiver LIKE concat('%',#{receiver},'%')
            </if>
            <if test="telephone!=null and telephone!=''">
                and telephone = #{telephone}
            </if>
            <if test="warehouseNo!=null and warehouseNo!=''">
                and warehouse_no = #{warehouseNo}
            </if>
            <if test="companyNo!=null and companyNo!=''">
                and company_no = #{companyNo}
            </if>
            <if test="logisticType!=null and logisticType!=''">
                and logistic_type = #{logisticType}
            </if>
            <if test="closeReason!=null and closeReason!=''">
                and close_reason = #{closeReason}
            </if>

            <if test=" startGmtCreate!= null ">
                and   <![CDATA[ gmt_create >= #{startGmtCreate} ]]>
            </if>
            <if test=" endGmtCreate != null ">
                and    <![CDATA[ gmt_create <= #{endGmtCreate} ]]>
            </if>
            <if test = "companyNo != null">
                and company_no = #{companyNo}
            </if>
        </where>
    </select>
    <select id="selectBySkuCode" resultMap="BaseResultMap"  parameterType="java.lang.String">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        `mall_sub_order`
        WHERE sku_code=#{skuCode}
    </select>
    <select id="selectBySubOrderNo" resultMap="BaseResultMap"  parameterType="java.lang.String">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        `mall_sub_order`
        WHERE sku_code=#{skuCode}
    </select>
    <select id="list" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        `mall_sub_order`
    </select>



    <sql id="commonSelectSection">
        1 = 1
        <if test="subOrderNo != null">
            and T1.sub_order_no = #{subOrderNo}
        </if>
        <if test="shopCode != null">
            and T1.shop_code = #{shopCode}
        </if>
        <if test="companyNo != null">
            and T1.company_no = #{companyNo}
        </if>

        <if test="channelOrderNo != null">
            and T1.channel_order_no = #{channelOrderNo}
        </if>

        <if test="orderNo != null">
            and T1.order_no = #{orderNo}
        </if>


        <if test="shopCode != null">
            and T1.shop_code = #{shopCode}
        </if>


        <if test="status != null">
            and T1.status = #{status}
        </if>

        <if test=" isDel == true">
            and T1.is_del is true
        </if>
        <if test=" isDel == false">
            and T1.is_del is false
        </if>
        <if test=" isDel == null">
            and T1.is_del is false
        </if>

    </sql>

    <sql id="tableSection">mall_sub_order</sql>
    <!--查询总条数 -->
    <select id="selectSubOrder" resultMap="com.wangqin.globalshop.biz1.app.dal.mapper.MallSubOrderDOMapper.BaseResultMap"
    >
        SELECT <include refid="com.wangqin.globalshop.biz1.app.dal.mapper.MallSubOrderDOMapper.Base_Column_List" />
        FROM <include refid="tableSection"/> T1
        WHERE
        <include refid="commonSelectSection"/>
    </select>

    <!--查询总条数 -->
    <select id="selectSubOrderCount" resultType="java.lang.Integer"
    >
        SELECT COUNT(*)
        FROM <include refid="tableSection"/> T1
        WHERE
        <include refid="commonSelectSection"/>
    </select>

    <!-- -->
    <select id="selectSubOrderList" resultMap="com.wangqin.globalshop.biz1.app.dal.mapper.MallSubOrderDOMapper.BaseResultMap"
    >
        SELECT  <include refid="com.wangqin.globalshop.biz1.app.dal.mapper.MallSubOrderDOMapper.Base_Column_List" />
        FROM <include refid="tableSection"/> T1
        WHERE
        <include refid="commonSelectSection"/>
        ORDER BY T1.id desc
    </select>


    <select id="queryHaihuErpOrders" resultType="com.wangqin.globalshop.biz1.app.dal.dataObject.MallSubOrderDO">
        SELECT
        <include refid="Base_Column_List" />
        FROM
        <include refid="tableSection"/> T1
        WHERE
        T1.receiver='地址稍后'  and T1.status=0
        <if test="shopCode!=null">
            and T1.shop_code = #{shopCode}
        </if>
        <if test="skuCode!=null">
            and T1.sku_code = #{skuCode}
        </if>
        <if test="quantity>0">
            and T1.quantity >= #{quantity}
        </if>
        LIMIT 0,1
    </select>
    <select id="selectBatchIds" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM mall_sub_order
        WHERE id IN
        <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
    
    <!-- 一键分享，我的订单 -->
    <select id="queryOrderByShareUserId" resultType="com.wangqin.globalshop.biz1.app.dto.MyOrderDTO" >
    	SELECT 
    	share_time AS time,count(1) AS orderCount,sum(share_money) AS commission
    	FROM mall_sub_order
    	<where>
    	share_user_id=#{shareUserId}
    	</where>
    	<![CDATA[ LIMIT #{start},#{pageSize} ]]>
    	GROUP BY share_time
    </select>
    
    
    <!-- 一键分享，订单详情 -->
    <select id="queryOrderDetailByTime" resultMap="BaseResultMap" >
    	SELECT 
    	<include refid="com.wangqin.globalshop.biz1.app.dal.mapper.MallSubOrderDOMapper.Base_Column_List" />
    	FROM mall_sub_order
    	<where>
    	share_user_id=#{shareUserId}
    	AND share_time=#{shareTime}
    	</where>
    	<![CDATA[ LIMIT #{start},#{pageSize} ]]>
    </select>

</mapper>
