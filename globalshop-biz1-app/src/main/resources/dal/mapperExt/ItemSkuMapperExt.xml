<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wangqin.globalshop.biz1.app.dal.mapperExt.ItemSkuMapperExt">
<!-- 通用查询结果列-->
    <resultMap id="BaseResultMap" type="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO" >
        <id column="id" property="id" jdbcType="BIGINT" />
        <result column="sku_code" property="skuCode" jdbcType="VARCHAR" />
        <result column="item_code" property="itemCode" jdbcType="VARCHAR" />
        <result column="item_name" property="itemName" jdbcType="VARCHAR" />
        <result column="company_no" property="companyNo" jdbcType="VARCHAR" />
        <result column="category_code" property="categoryCode" jdbcType="VARCHAR" />
        <result column="category_name" property="categoryName" jdbcType="VARCHAR" />
        <result column="upc" property="upc" jdbcType="VARCHAR" />
        <result column="saleable" property="saleable" jdbcType="TINYINT" />
        <result column="purchase_price" property="purchasePrice" jdbcType="DOUBLE" />
        <result column="freight" property="freight" jdbcType="BIGINT" />
        <result column="discount" property="discount" jdbcType="DOUBLE" />
        <result column="logistic_type" property="logisticType" jdbcType="TINYINT" />
        <result column="cost_price" property="costPrice" jdbcType="DOUBLE" />
        <result column="brand_name" property="brandName" jdbcType="VARCHAR" />
        <result column="weight" property="weight" jdbcType="DOUBLE" />
        <result column="sku_pic" property="skuPic" jdbcType="VARCHAR" />
        <result column="package_code" property="packageCode" jdbcType="VARCHAR" />
        <result column="package_name" property="packageName" jdbcType="VARCHAR" />
        <result column="package_en" property="packageEn" jdbcType="VARCHAR" />
        <result column="package_weight" property="packageWeight" jdbcType="DOUBLE" />
        <result column="package_level_id" property="packageLevelId" jdbcType="VARCHAR" />
        <result column="scale" property="scale" jdbcType="VARCHAR" />
        <result column="model" property="model" jdbcType="VARCHAR" />
        <result column="sale_type" property="saleType" jdbcType="BIT" />
        <result column="sale_price" property="salePrice" jdbcType="DOUBLE" />
        <result column="creator" property="creator" jdbcType="VARCHAR" />
        <result column="modifier" property="modifier" jdbcType="VARCHAR" />
        <result column="gmt_create" property="gmtCreate" jdbcType="TIMESTAMP" />
        <result column="gmt_modify" property="gmtModify" jdbcType="TIMESTAMP" />
        <result column="is_del" property="isDel" jdbcType="BIT" />
    </resultMap>
    <resultMap id="ResultMapWithBLOBs" type="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO" extends="BaseResultMap" >
        <result column="remark" property="remark" jdbcType="LONGVARCHAR" />
    </resultMap>
    
    <resultMap id="SaleableMap" type="com.wangqin.globalshop.biz1.app.dto.InventoryItemSkuDTO" >
        <id column="id" property="id" jdbcType="BIGINT" />
        <result column="sku_code" property="skuCode" jdbcType="VARCHAR" />
        <result column="item_code" property="itemCode" jdbcType="VARCHAR" />
        <result column="item_name" property="itemName" jdbcType="VARCHAR" />
        <result column="company_no" property="companyNo" jdbcType="VARCHAR" />
        <result column="category_code" property="categoryCode" jdbcType="VARCHAR" />
        <result column="category_name" property="categoryName" jdbcType="VARCHAR" />
        <result column="upc" property="upc" jdbcType="VARCHAR" />
        <result column="saleable" property="saleable" jdbcType="TINYINT" />
        <result column="purchase_price" property="purchasePrice" jdbcType="DOUBLE" />
        <result column="freight" property="freight" jdbcType="BIGINT" />
        <result column="discount" property="discount" jdbcType="DOUBLE" />
        <result column="logistic_type" property="logisticType" jdbcType="TINYINT" />
        <result column="cost_price" property="costPrice" jdbcType="DOUBLE" />
        <result column="brand_name" property="brandName" jdbcType="VARCHAR" />
        <result column="weight" property="weight" jdbcType="DOUBLE" />
        <result column="sku_pic" property="skuPic" jdbcType="VARCHAR" />
        <result column="package_code" property="packageCode" jdbcType="VARCHAR" />
        <result column="package_name" property="packageName" jdbcType="VARCHAR" />
        <result column="package_en" property="packageEn" jdbcType="VARCHAR" />
        <result column="package_weight" property="packageWeight" jdbcType="DOUBLE" />
        <result column="package_level_id" property="packageLevelId" jdbcType="VARCHAR" />
        <result column="scale" property="scale" jdbcType="VARCHAR" />
        <result column="model" property="model" jdbcType="VARCHAR" />
        <result column="sale_type" property="saleType" jdbcType="BIT" />
        <result column="sale_price" property="salePrice" jdbcType="DOUBLE" />
        <result column="creator" property="creator" jdbcType="VARCHAR" />
        <result column="modifier" property="modifier" jdbcType="VARCHAR" />
        <result column="gmt_create" property="gmtCreate" jdbcType="TIMESTAMP" />
        <result column="gmt_modify" property="gmtModify" jdbcType="TIMESTAMP" />
        <result column="is_del" property="isDel" jdbcType="BIT" />
        <result column="virtual_inv" property="virtualInv" jdbcType="BIGINT" />
    </resultMap>
    
    <sql id="Base_Column_List" >
        T1.id,  T1.sku_code,  T1.item_code,  T1.item_name,  T1.company_no,  T1.category_code, 
         T1.category_name,  T1.upc,T1.saleable,  T1.purchase_price,  T1.freight, 
          T1.discount,  T1.logistic_type,  T1.cost_price,  T1.brand_name,
         T1.weight,  T1.sku_pic,  T1.package_code,  T1.package_name,  T1.package_en, 
         T1.package_weight,  T1.package_level_id,
         T1.scale,  T1.model,  T1.sale_type,  T1.sale_price,  T1.creator,  T1.modifier,
          T1.gmt_create,  T1.gmt_modify,  T1.is_del
    </sql>
    
    <!-- 查询可售的sku -->
     <select id="querySaleableSkus" resultMap="SaleableMap" >
        SELECT
        	 <include refid="Base_Column_List" />,inv.virtual_inv AS virtualInv
        FROM
            item_sku T1 left join inventory inv on T1.sku_code= inv.sku_code
        where
           T1.is_del=0
             AND ((IFNULL(inv.inv,0)+IFNULL(inv.virtual_inv,0)-IFNULL(locked_inv,0)) > 0)
    </select>

	<select id="queryItemSkusCount" resultType="java.lang.Integer"  parameterType="com.wangqin.globalshop.biz1.app.vo.ItemSkuQueryVO">
        SELECT
        	count(1)
         FROM
            item_sku T1 left join inventory inv on T1.sku_code= inv.sku_code
        where
           T1.is_del=0
              <if test=" itemName != null and itemName != '' ">
                and T1.item_name LIKE concat('%',#{itemName},'%')
            </if>
            <if test=" itemCode != null and itemCode != '' ">
               and T1.item_code = #{itemCode}
            </if>
             <if test=" upc != null and upc != '' ">
               and T1.upc = #{upc}
            </if>
            <if test=" skuCode != null and skuCode != '' ">
               and T1.sku_code = #{skuCode}
            </if>

            <if test=" brand != null and brand != ''">
              and  T1.brand_name = #{brand}
            </if>
            <if test=" startGmt!= null ">
             and   <![CDATA[ T1.gmt_create >= #{startGmt} ]]>
            </if>
            <if test=" endGmt != null ">
            and    <![CDATA[ T1.gmt_create <= #{endGmt} ]]>
            </if>
    </select>
    
    <select id="queryItemSkus" resultType="com.wangqin.globalshop.biz1.app.dto.ISkuDTO" parameterType="com.wangqin.globalshop.biz1.app.vo.ItemSkuQueryVO">
        SELECT
        	 T1.id as id,T1.sale_type AS saleType,T1.brand_name as brand,
        	 T1.weight as weight,T1.sku_pic as skuPic,T1.item_name AS itemName,
        	 T1.category_name AS categoryName,T1.item_code AS itemCode,T1.sku_code AS skuCode,
             inv.locked_inv as lockedInv,inv.inv as inventory
			 ,inv.virtual_inv as virtualInv,inv.locked_virtual_inv lockedVirtualInv,
			 inv.trans_inv as transInv,inv.locked_trans_inv as lockedTransInv,
			 (inv.inv-inv.locked_inv+inv.trans_inv-inv.locked_trans_inv) as totalAvailableInv
        FROM
            item_sku T1 left join inventory inv on T1.sku_code= inv.sku_code
        where
           T1.is_del=0
              <if test=" itemName != null and itemName != '' ">
                and T1.item_name LIKE concat('%',#{itemName},'%')
            </if>
            <if test=" itemCode != null and itemCode != '' ">
               and T1.item_code = #{itemCode}
            </if>
             <if test=" upc != null and upc != '' ">
               and T1.upc = #{upc}
            </if>
            <if test=" skuCode != null and skuCode != '' ">
               and T1.sku_code = #{skuCode}
            </if>

            <if test=" brand != null and brand != ''">
              and  T1.brand_name = #{brand}
            </if>
            <if test=" startGmt!= null ">
             and   <![CDATA[ T1.gmt_create >= #{startGmt} ]]>
            </if>
            <if test=" endGmt != null ">
            and    <![CDATA[ T1.gmt_create <= #{endGmt} ]]>
            </if>
          order by T1.id desc
          	<![CDATA[ LIMIT #{firstStart},#{pageSize} ]]>
    </select>
    
    <!-- 通过skuCode查找单个sku -->
     <select id="queryItemSkuBySkuCode" resultType="com.wangqin.globalshop.biz1.app.dto.ISkuDTO" parameterType="java.lang.String">
        SELECT
        	 T1.id as id,T1.sale_type AS saleType,T1.brand_name as brand,
        	 T1.weight as weight,T1.sku_pic as skuPic,T1.item_name AS itemName,
        	 T1.category_name AS categoryName,T1.item_code AS itemCode,T1.sku_code AS skuCode,
             inv.locked_inv as lockedInv,inv.inv as inventory
			 ,inv.virtual_inv as virtualInv,inv.locked_virtual_inv lockedVirtualInv,
			 inv.trans_inv as transInv,inv.locked_trans_inv as lockedTransInv,
			 (inv.inv-inv.locked_inv+inv.trans_inv-inv.locked_trans_inv) as totalAvailableInv
        FROM
            item_sku T1 left join inventory inv on T1.sku_code= inv.sku_code
        where
           T1.is_del=0
           AND
           T1.sku_code=#{skuCode}
    </select>

    <!-- 根据id更新itemsku -->
    <update id="updateById" parameterType="com.wangqin.globalshop.biz1.app.vo.ItemSkuQueryVO" >
    update item_sku
    <set >
      <if test="salePrice != null" >
        sale_price = #{salePrice},
      </if>
      <if test="scale != null" >
        scale = #{scale},
      </if>
      <if test="upc != null" >
        upc = #{upc},
      </if>
      <if test="weight != null" >
        weight = #{weight},
      </if>
      <if test="brand != null" >
        brand_name = #{brand},
      </if>
      <if test="skuPic != null" >
        sku_pic = #{skuPic},
      </if>
      <if test="creator != null" >
        creator = #{creator},
      </if>
      <if test="modifier != null" >
        modifier = #{modifier},
      </if>
    </set>
    where id = #{id}
  </update>


     <select id="queryItemSkusById" resultType="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO" >
        SELECT
        	 T1.id as id,T1.sale_type AS saleType,T1.weight as weight,T1.sku_pic as skuPic,T1.item_name AS itemName,T1.category_name AS categoryName,
			 T1.item_code AS itemCode,T1.sku_code AS skuCode,T1.upc as upc,T1.salable as salable,T1.color as color,T1.scale as scale,T1.purchase_price AS purchasePrice,T1.freight AS freight,T1.sale_price AS salePrice,T1.remark as remark,T1.gmt_create AS gmtCreate,T1.gmt_modify AS gmtModify,T1.user_create AS userCreate,T1.user_modify AS userModify,
			 T1.package_id as packageId,T1.package_level_id as packageLevelId,T1.package_name AS packageName,T1.package_en as packageEn,T1.package_weight as packageWeight,inv.locked_inv as lockedInv,inv.inv as inventory
			 ,inv.virtual_inv as virtualInv,inv.locked_virtual_inv lockedVirtualInv,inv.trans_inv as transInv,inv.locked_trans_inv as lockedTransInv,(inv.inv-inv.locked_inv+inv.trans_inv-inv.locked_trans_inv) as totalAvailableInv,T1.cost_price AS costPrice,T1.discount AS discount,T1.third_sku_code AS thirdSkuCode
        FROM
            item_sku T1 left join inventory inv on T1.id= inv.sku_id 
        where
          1=1
          <if test=" itemId != null and itemId != '' ">
            and T1.item_id = #{itemId}
          </if>
          <if test=" skuId != null and skuId != '' ">
            and T1.id = #{skuId}
          </if>
    </select>
    
    <select id="queryMaxSkuCodeIndex" resultType="java.lang.Integer"  parameterType="java.lang.Long">
    	select (RIGHT(sku_code, 4)+0) as maxIndex from item_sku where item_id=#{itemId} order by sku_code desc limit 1;
    </select>
    
    <!-- 判断sku是否在订单详情中 -->
    <select id="queryItemSkusCountInOrder" resultType="java.lang.Integer"  parameterType="java.lang.Long">
    	SELECT 1 FROM erp_order WHERE sku_id=#{skuId} and status!=-1 LIMIT 1
    </select>
    <!-- 判断sku是否在采购任务中 -->
    <select id="queryItemSkusCountInTask" resultType="java.lang.Integer"  parameterType="java.lang.Long">
    	SELECT 1 FROM task_daily_detail WHERE sku_id=#{skuId} LIMIT 1
    </select>
    <!-- 判断sku是否在入库详情中 -->
    <select id="queryItemSkusCountInPurchase" resultType="java.lang.Integer"  parameterType="java.lang.Long">
    	SELECT 1 FROM purchase_storage_detail WHERE sku_id=#{skuId} LIMIT 1
    </select>
    <!-- 判断sku是否在库存中 -->
    <select id="queryItemSkusCountInInventoryArea" resultType="java.lang.Integer"  parameterType="java.lang.Long">
    	SELECT 1 FROM inventory_area WHERE sku_id=#{skuId} LIMIT 1
    </select>
    
    <select id="queryItemSkusForExcel" resultType="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO" >
        SELECT a.name as itemName,a.brand,b.sku_pic as skuPic ,b.color,b.scale,b.sale_price as salePrice 
		FROM item a 
		LEFT JOIN item_sku b ON a.id=b.item_id
		WHERE a.status=1
    </select>
    

    
    
<!-- 根据upc获取商品信息(item_sku),@Author:XiaJun -->
<select id="queryItemSkusByUpc" resultType="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO" parameterType="java.lang.String">
     SELECT
        <include refid="Base_Column_List" />, inv.inv as inventory,inv.virtual_inv as virtualInv
        FROM
            item_sku T1 left join inventory inv on T1.id= inv.sku_id 
        where
          <if test=" _parameter!= null">
            T1.upc = #{upc}
          </if>
</select>
<select id="queryItemBySkuCode" resultMap="BaseResultMap" parameterType="java.lang.String">
     SELECT
        <include refid="Base_Column_List" />
        FROM
            item_sku
        where
           sku_code = #{skuCode}
</select>


   <insert id="insertBatch" parameterType="java.util.List" useGeneratedKeys="true">
        <selectKey resultType="long" keyProperty="id" order="AFTER">
            SELECT
            LAST_INSERT_ID()
        </selectKey>
        insert into item_sku
        (sku_code,item_code,item_name,company_no,upc,creator,modifier,sale_price)

        values
        <foreach collection="list" item="wdSolr" index="index"
            separator=",">
            (
            #{wdSolr.skuCode},#{wdSolr.itemCode},#{wdSolr.itemName},#{wdSolr.companyNo},
            #{wdSolr.upc},#{wdSolr.creator},#{wdSolr.modifier},#{wdSolr.salePrice}
            )
        </foreach>
    </insert>

<!-- 删除sku -->
    <update id="deleteById" parameterType="java.lang.Long">
    	update item_sku
    	set is_del=1
    	where id=#{id}
    </update>


    <sql id="tableSection">item_sku</sql>

    <sql id="commonSelectSection">
        1 = 1
        <if test="itemCode != null">
            and T1.item_code = #{itemCode}
        </if>
        <if test="skuCode != null">
            and T1.sku_code = #{skuCode}
        </if>
        <if test="companyNo != null">
            and T1.company_no = #{companyNo}
        </if>
        <if test="itemName != null">
            and T1.item_name = #{itemName}
        </if>
        <if test="categoryCode != null">
            and T1.category_code = #{categoryCode}
        </if>

        <if test="upc != null">
            and T1.upc = #{upc}
        </if>
        <if test="id != null">
            and T1.id  = #{id}
        </if>
        <if test="status != null">
            and T1.status = #{status}
        </if>
        <if test=" isDel == true">
            and T1.is_del is true
        </if>
        <if test=" isDel == false">
            and T1.is_del is false
        </if>
        <if test=" isDel == null">
            and T1.is_del is false
        </if>

    </sql>


    <!--查询总条数 -->
    <select id="queryItemSku" resultType="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO" parameterType="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO">
        SELECT <include refid="com.wangqin.globalshop.biz1.app.dal.mapper.ItemSkuDOMapper.Base_Column_List" />
        FROM <include refid="tableSection"/> T1
        WHERE
        <include refid="commonSelectSection"/>
    </select>

    <!--查询总条数 -->
    <select id="queryItemSkuCount" resultType="java.lang.Integer" parameterType="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO">
        SELECT COUNT(*)
        FROM <include refid="tableSection"/> T1
        WHERE
        <include refid="commonSelectSection"/>
    </select>

    <!-- -->
    <select id="queryItemSkuList" resultMap="com.wangqin.globalshop.biz1.app.dal.mapper.ItemSkuDOMapper.BaseResultMap" parameterType="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO">
        SELECT  <include refid="com.wangqin.globalshop.biz1.app.dal.mapper.ItemSkuDOMapper.Base_Column_List" />
        FROM <include refid="tableSection"/> T1
        WHERE
        <include refid="commonSelectSection"/>
        ORDER BY T1.id desc
    </select>

    <select id="queryItemSkusForItemThirdSale" resultType="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO" >
        SELECT
        <include refid="Base_Column_List_with_table" />, T2.quantity AS itemSkuQuantity
        FROM <include refid="tableSection"/> T1 LEFT JOIN  mall_sub_order T2 on T1.sku_code= T2.sku_code
        WHERE
        1=1
        <if test="itemCode != null">
           and T1.item_code = #{itemCode}
        </if>
        <if test="shopCode != null">
            and T2.shop_code = #{shopCode}
        </if>
        AND T2.receiver = '地址稍后'
        AND T2.quantity >1
    </select>

    <sql id="Base_Column_List_with_table" >
        T1.id, T1.sku_code, T1.item_code, T1.item_name, T1.company_no, T1.category_code, T1.category_name, T1.upc,
        T1.saleable, T1.purchase_price, T1.freight, T1.discount, T1.logistic_type, T1.cost_price, T1.brand_name,
        T1.weight, T1.sku_pic, T1.package_code, T1.package_name, T1.package_en, T1.package_weight, T1.package_level_id,
        T1.scale, model, T1.sale_type, T1.sale_price, T1.creator, T1.modifier, T1.gmt_create, T1.gmt_modify, T1.is_del
    </sql>

</mapper>
