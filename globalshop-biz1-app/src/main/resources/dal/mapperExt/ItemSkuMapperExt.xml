<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wangqin.globalshop.biz1.app.dal.mapperExt.ItemSkuMapperExt">
<!-- 通用查询结果列-->
    <resultMap id="BaseResultMap" type="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO" >
        <id column="id" property="id" jdbcType="BIGINT" />
        <result column="sku_code" property="skuCode" jdbcType="VARCHAR" />
        <result column="item_code" property="itemCode" jdbcType="VARCHAR" />
        <result column="item_name" property="itemName" jdbcType="VARCHAR" />
        <result column="company_no" property="companyNo" jdbcType="VARCHAR" />
        <result column="category_code" property="categoryCode" jdbcType="VARCHAR" />
        <result column="category_name" property="categoryName" jdbcType="VARCHAR" />
        <result column="upc" property="upc" jdbcType="VARCHAR" />
        <result column="saleable" property="saleable" jdbcType="TINYINT" />
        <result column="purchase_price" property="purchasePrice" jdbcType="DOUBLE" />
        <result column="freight" property="freight" jdbcType="BIGINT" />
        <result column="discount" property="discount" jdbcType="DOUBLE" />
        <result column="logistic_type" property="logisticType" jdbcType="TINYINT" />
        <result column="cost_price" property="costPrice" jdbcType="DOUBLE" />
        <result column="brand_name" property="brandName" jdbcType="VARCHAR" />
        <result column="weight" property="weight" jdbcType="DOUBLE" />
        <result column="sku_pic" property="skuPic" jdbcType="VARCHAR" />
        <result column="package_code" property="packageCode" jdbcType="VARCHAR" />
        <result column="package_name" property="packageName" jdbcType="VARCHAR" />
        <result column="package_en" property="packageEn" jdbcType="VARCHAR" />
        <result column="package_weight" property="packageWeight" jdbcType="DOUBLE" />
        <result column="package_level_id" property="packageLevelId" jdbcType="VARCHAR" />
        <result column="scale" property="scale" jdbcType="VARCHAR" />
        <result column="model" property="model" jdbcType="VARCHAR" />
        <result column="sale_type" property="saleType" jdbcType="BIT" />
        <result column="sale_price" property="salePrice" jdbcType="DOUBLE" />
        <result column="creator" property="creator" jdbcType="VARCHAR" />
        <result column="modifier" property="modifier" jdbcType="VARCHAR" />
        <result column="gmt_create" property="gmtCreate" jdbcType="TIMESTAMP" />
        <result column="gmt_modify" property="gmtModify" jdbcType="TIMESTAMP" />
        <result column="is_del" property="isDel" jdbcType="BIT" />
    </resultMap>
    <resultMap id="ResultMapWithBLOBs" type="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO" extends="BaseResultMap" >
        <result column="remark" property="remark" jdbcType="LONGVARCHAR" />
    </resultMap>
    
    <resultMap id="SaleableMap" type="com.wangqin.globalshop.biz1.app.dto.InventoryItemSkuDTO" >
        <id column="id" property="id" jdbcType="BIGINT" />
        <result column="sku_code" property="skuCode" jdbcType="VARCHAR" />
        <result column="item_code" property="itemCode" jdbcType="VARCHAR" />
        <result column="item_name" property="itemName" jdbcType="VARCHAR" />
        <result column="company_no" property="companyNo" jdbcType="VARCHAR" />
        <result column="category_code" property="categoryCode" jdbcType="VARCHAR" />
        <result column="category_name" property="categoryName" jdbcType="VARCHAR" />
        <result column="upc" property="upc" jdbcType="VARCHAR" />
        <result column="saleable" property="saleable" jdbcType="TINYINT" />
        <result column="purchase_price" property="purchasePrice" jdbcType="DOUBLE" />
        <result column="freight" property="freight" jdbcType="BIGINT" />
        <result column="discount" property="discount" jdbcType="DOUBLE" />
        <result column="logistic_type" property="logisticType" jdbcType="TINYINT" />
        <result column="cost_price" property="costPrice" jdbcType="DOUBLE" />
        <result column="brand_name" property="brandName" jdbcType="VARCHAR" />
        <result column="weight" property="weight" jdbcType="DOUBLE" />
        <result column="sku_pic" property="skuPic" jdbcType="VARCHAR" />
        <result column="package_code" property="packageCode" jdbcType="VARCHAR" />
        <result column="package_name" property="packageName" jdbcType="VARCHAR" />
        <result column="package_en" property="packageEn" jdbcType="VARCHAR" />
        <result column="package_weight" property="packageWeight" jdbcType="DOUBLE" />
        <result column="package_level_id" property="packageLevelId" jdbcType="VARCHAR" />
        <result column="scale" property="scale" jdbcType="VARCHAR" />
        <result column="model" property="model" jdbcType="VARCHAR" />
        <result column="sale_type" property="saleType" jdbcType="BIT" />
        <result column="sale_price" property="salePrice" jdbcType="DOUBLE" />
        <result column="creator" property="creator" jdbcType="VARCHAR" />
        <result column="modifier" property="modifier" jdbcType="VARCHAR" />
        <result column="gmt_create" property="gmtCreate" jdbcType="TIMESTAMP" />
        <result column="gmt_modify" property="gmtModify" jdbcType="TIMESTAMP" />
        <result column="is_del" property="isDel" jdbcType="BIT" />
        <result column="virtual_inv" property="virtualInv" jdbcType="BIGINT" />
    </resultMap>
    
    <sql id="Base_Column_List" >
       	 id,  sku_code,  item_code,  item_name,  company_no,  category_code, 
         category_name,  upc, saleable,  purchase_price,  freight, 
         discount,  logistic_type,  cost_price,  brand_name,
         weight,  sku_pic,  package_code,  package_name,  package_en, 
         package_weight,  package_level_id,weight,
         scale,  model,  sale_type,  sale_price,  creator,  modifier,
          gmt_create,  gmt_modify,  is_del
    </sql>
    
    <!-- 商品编辑使用 -->
    <sql id="Base_Column_List_For_Item_Edit" >
        T1.id,T1.sku_code AS skuCode,T1.item_code AS itemCode,
        T1.item_name AS itemName,T1.company_no AS companyNo, 
        T1.category_code AS itemCode, 
        T1.category_name AS categoryName,  
        T1.upc AS upc,               
        T1.weight AS weight,T1.sku_pic AS skuPic, 
        T1.package_level_id AS packageLevelId,
        T1.sale_price AS salePrice,
        inv.virtual_inv AS virtualInv
    </sql>
    
    <!-- 查询可售的sku -->
     <select id="querySaleableSkus" resultMap="SaleableMap" >
        SELECT
        	 <include refid="Base_Column_List" />,inv.virtual_inv AS virtualInv
        FROM
            item_sku T1 left join inventory inv on T1.sku_code= inv.sku_code
        where
           T1.is_del=0
             AND ((IFNULL(inv.inv,0)+IFNULL(inv.virtual_inv,0)-IFNULL(locked_inv,0)) > 0)
    </select>

	<select id="queryItemSkusCount" resultType="java.lang.Integer"  parameterType="com.wangqin.globalshop.biz1.app.vo.ItemSkuQueryVO">
        SELECT
        	count(1)
         FROM
            item_sku T1 left join inventory inv on T1.sku_code= inv.sku_code
        where
           T1.is_del=0
            <if test=" categoryCode != null and categoryCode != '' ">
                and T1.category_code = #{categoryCode}
            </if>
            <if test=" companyNo != null and companyNo != '' ">
                and T1.company_no = #{companyNo}
            </if>
            <if test=" itemName != null and itemName != '' ">
                and T1.item_name LIKE concat('%',#{itemName},'%')
            </if>
            <if test=" itemCode != null and itemCode != '' ">
               and T1.item_code = #{itemCode}
            </if>
             <if test=" upc != null and upc != '' ">
               and T1.upc = #{upc}
            </if>
            <if test=" skuCode != null and skuCode != '' ">
               and T1.sku_code = #{skuCode}
            </if>

            <if test=" brand != null and brand != ''">
              and  T1.brand_name = #{brand}
            </if>
            <if test=" startGmt!= null ">
             and   <![CDATA[ T1.gmt_create >= #{startGmt} ]]>
            </if>
            <if test=" endGmt != null ">
            and    <![CDATA[ T1.gmt_create <= #{endGmt} ]]>
            </if>
    </select>
    
    <!-- 查询sku列表 -->
    <!-- 可售库存=现货库存+虚拟库存-占用库存 -->
    <select id="queryItemSkus" resultType="com.wangqin.globalshop.biz1.app.dto.ISkuDTO" parameterType="com.wangqin.globalshop.biz1.app.vo.ItemSkuQueryVO">
        SELECT
        	 T1.id as id,T1.sale_type AS saleType,T1.brand_name as brand,
        	 T1.weight as weight,T1.sku_pic as skuPic,T1.item_name AS itemName,
        	 T1.category_name AS categoryName, T1.upc AS upc, T1.item_code AS itemCode,
        	 T1.sku_code AS skuCode,T1.sale_price AS salePrice,T1.gmt_modify AS gmtModify,
        	 (inv.inv+inv.virtual_inv-inv.locked_inv) as totalAvailableInv,<!-- 可售库存 -->           
			 inv.virtual_inv as virtualInv,<!-- 虚拟库存 --> 
			 inv.inv AS inventory,<!-- 现货库存 --> 
			 inv.locked_inv AS lockedInv<!-- 占用库存 --> 		 
        FROM
            item_sku T1 left join inventory inv on T1.sku_code= inv.sku_code
        where
           T1.is_del=0
            <if test=" categoryCode != null and categoryCode != '' ">
                and T1.category_code = #{categoryCode}
            </if>
            <if test=" companyNo != null and companyNo != '' ">
                and T1.company_no = #{companyNo}
            </if>
            <if test=" itemName != null and itemName != '' ">
                and T1.item_name LIKE concat('%',#{itemName},'%')
            </if>
            <if test=" itemCode != null and itemCode != '' ">
               and T1.item_code = #{itemCode}
            </if>
             <if test=" upc != null and upc != '' ">
               and T1.upc = #{upc}
            </if>
            <if test=" skuCode != null and skuCode != '' ">
               and T1.sku_code = #{skuCode}
            </if>

            <if test=" brand != null and brand != ''">
              and  T1.brand_name = #{brand}
            </if>
            <if test=" startGmt!= null ">
             and   <![CDATA[ T1.gmt_create >= #{startGmt} ]]>
            </if>
            <if test=" endGmt != null ">
            and    <![CDATA[ T1.gmt_create <= #{endGmt} ]]>
            </if>
          order by T1.id desc
          	<![CDATA[ LIMIT #{firstStart},#{pageSize} ]]>
    </select>
    
    <!-- 根据条件查询itemSkuList，不涉及其他的表 ，不做分页-->
     <select id="queryItemSkuListSelective" resultType="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO" parameterType="com.wangqin.globalshop.biz1.app.vo.ItemSkuQueryVO">
        SELECT
        	 T1.sku_code AS skuCode
        FROM
            item_sku T1
        where
           T1.is_del=0
            <if test=" companyNo != null and companyNo != '' ">
                and T1.company_no = #{companyNo}
            </if>
            <if test=" itemCode != null and itemCode != '' ">
               and T1.item_code = #{itemCode}
            </if>
    </select>
    
    <!-- 通过skuCode查找单个sku -->
     <select id="queryItemSkuBySkuCode" resultType="com.wangqin.globalshop.biz1.app.dto.ISkuDTO" parameterType="java.lang.String">
        SELECT
        	 T1.id as id,T1.sale_type AS saleType,T1.brand_name as brand,
        	 T1.weight as weight,T1.sku_pic as skuPic,T1.item_name AS itemName,
        	 T1.category_name AS categoryName,T1.item_code AS itemCode,T1.sku_code AS skuCode,
        	 T1.upc,T1.sale_price AS salePrice,T1.sku_pic AS skuPic,
        	 T1.package_level_id AS packageLevelId,
             inv.locked_inv as lockedInv,inv.inv as inventory
			 ,inv.virtual_inv as virtualInv,inv.locked_virtual_inv lockedVirtualInv,
			 inv.trans_inv as transInv,inv.locked_trans_inv as lockedTransInv,
			 (inv.inv-inv.locked_inv+inv.trans_inv-inv.locked_trans_inv) as totalAvailableInv
        FROM
            item_sku T1 left join inventory inv on T1.sku_code= inv.sku_code
        where
           T1.is_del=0
           AND
           T1.sku_code=#{skuCode}
    </select>

    <!-- 根据id更新itemsku -->
    <update id="updateById" parameterType="com.wangqin.globalshop.biz1.app.vo.ItemSkuQueryVO" >
    update item_sku
    <set >
      <if test="salePrice != null" >
        sale_price = #{salePrice},
      </if>
      <if test="scale != null" >
        scale = #{scale},
      </if>
      <if test="upc != null" >
        upc = #{upc},
      </if>
      <if test="packageLevelId != null" >
        package_level_id = #{packageLevelId},
      </if>
      <if test="weight != null" >
        weight = #{weight},
      </if>
      <if test="brand != null" >
        brand_name = #{brand},
      </if>
      <if test="skuPic != null" >
        sku_pic = #{skuPic},
      </if>
      <if test="creator != null" >
        creator = #{creator},
      </if>
      <if test="modifier != null" >
        modifier = #{modifier},
      </if>
    </set>
    where id = #{id}
  </update>


     <select id="queryItemSkusById" resultType="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO" >
        SELECT
        	 T1.id as id,T1.sale_type AS saleType,T1.weight as weight,T1.sku_pic as skuPic,T1.item_name AS itemName,T1.category_name AS categoryName,
			 T1.item_code AS itemCode,T1.sku_code AS skuCode,T1.upc as upc,T1.salable as salable,T1.color as color,T1.scale as scale,T1.purchase_price AS purchasePrice,T1.freight AS freight,T1.sale_price AS salePrice,T1.remark as remark,T1.gmt_create AS gmtCreate,T1.gmt_modify AS gmtModify,T1.user_create AS userCreate,T1.user_modify AS userModify,
			 T1.package_id as packageId,T1.package_level_id as packageLevelId,T1.package_name AS packageName,T1.package_en as packageEn,T1.package_weight as packageWeight,inv.locked_inv as lockedInv,inv.inv as inventory
			 ,inv.virtual_inv as virtualInv,inv.locked_virtual_inv lockedVirtualInv,inv.trans_inv as transInv,inv.locked_trans_inv as lockedTransInv,(inv.inv-inv.locked_inv+inv.trans_inv-inv.locked_trans_inv) as totalAvailableInv,T1.cost_price AS costPrice,T1.discount AS discount,T1.third_sku_code AS thirdSkuCode
        FROM
            item_sku T1 left join inventory inv on T1.id= inv.sku_id 
        where
          1=1
          <if test=" itemId != null and itemId != '' ">
            and T1.item_id = #{itemId}
          </if>
          <if test=" skuId != null and skuId != '' ">
            and T1.id = #{skuId}
          </if>
    </select>
    
    <select id="queryMaxSkuCodeIndex" resultType="java.lang.Integer"  parameterType="java.lang.Long">
    	select (RIGHT(sku_code, 4)+0) as maxIndex from item_sku where item_id=#{itemId} order by sku_code desc limit 1;
    </select>
    
    <!-- 判断sku是否在订单详情中 -->
    <select id="queryItemSkusCountInOrder" resultType="java.lang.Integer"  parameterType="java.lang.Long">
    	SELECT 1 FROM erp_order WHERE sku_id=#{skuId} and status!=-1 LIMIT 1
    </select>
    <!-- 判断sku是否在采购任务中 -->
    <select id="queryItemSkusCountInTask" resultType="java.lang.Integer"  parameterType="java.lang.Long">
    	SELECT 1 FROM task_daily_detail WHERE sku_id=#{skuId} LIMIT 1
    </select>
    <!-- 判断sku是否在入库详情中 -->
    <select id="queryItemSkusCountInPurchase" resultType="java.lang.Integer"  parameterType="java.lang.Long">
    	SELECT 1 FROM purchase_storage_detail WHERE sku_id=#{skuId} LIMIT 1
    </select>
    <!-- 判断sku是否在库存中 -->
    <select id="queryItemSkusCountInInventoryArea" resultType="java.lang.Integer"  parameterType="java.lang.Long">
    	SELECT 1 FROM inventory_area WHERE sku_id=#{skuId} LIMIT 1
    </select>
    
    <select id="queryItemSkusForExcel" resultType="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO" >
        SELECT a.name as itemName,a.brand,b.sku_pic as skuPic ,b.color,b.scale,b.sale_price as salePrice 
		FROM item a 
		LEFT JOIN item_sku b ON a.id=b.item_id
		WHERE a.status=1
    </select>
    

    
    
<!-- 根据upc获取商品信息(item_sku),@Author:XiaJun -->
<select id="queryItemSkusByUpc" resultType="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO" parameterType="java.lang.String">
     SELECT
        <include refid="Base_Column_List" />, inv.inv as inventory,inv.virtual_inv as virtualInv
        FROM
            item_sku T1 left join inventory inv on T1.id= inv.sku_id 
        where
          <if test=" _parameter!= null">
            T1.upc = #{upc}
          </if>
</select>
<select id="queryItemBySkuCode" resultMap="BaseResultMap" parameterType="java.lang.String">
     SELECT
        <include refid="Base_Column_List" />
        FROM
            item_sku T1
        where
           T1.sku_code = #{skuCode}
</select>

<!-- 批量插入sku -->
<insert id="insertBatch" parameterType="java.util.List" useGeneratedKeys="true">
  <selectKey resultType="long" keyProperty="id" order="AFTER">
            SELECT
            LAST_INSERT_ID()
        </selectKey>
        insert into item_sku
        (sku_code,sku_pic,cost_price,weight,item_code,item_name,company_no,upc,creator,modifier,
        sale_price,category_name,category_code,package_level_id,brand_name)

        values
        <foreach collection="list" item="wdSolr" index="index"
            separator=",">
            (
            #{wdSolr.skuCode}, #{wdSolr.skuPic}, #{wdSolr.costPrice},#{wdSolr.weight},
            #{wdSolr.itemCode},#{wdSolr.itemName},#{wdSolr.companyNo},
            #{wdSolr.upc},#{wdSolr.creator},#{wdSolr.modifier},#{wdSolr.salePrice},
            #{wdSolr.categoryName},#{wdSolr.categoryCode},#{wdSolr.packageLevelId},#{wdSolr.brand}
            )
        </foreach>
</insert>

<!-- 插入单个sku -->
   <insert id="insertItemSkuSelective" parameterType="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO" >
    insert into item_sku
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="skuCode != null" >
        sku_code,
      </if>
      <if test="itemCode != null" >
        item_code,
      </if>
      <if test="itemName != null" >
        item_name,
      </if>
      <if test="companyNo != null" >
        company_no,
      </if>
      <if test="categoryCode != null" >
        category_code,
      </if>
      <if test="categoryName != null" >
        category_name,
      </if>
      <if test="upc != null" >
        upc,
      </if>
      <if test="saleable != null" >
        saleable,
      </if>
      <if test="purchasePrice != null" >
        purchase_price,
      </if>
      <if test="freight != null" >
        freight,
      </if>
      <if test="discount != null" >
        discount,
      </if>
      <if test="logisticType != null" >
        logistic_type,
      </if>
      <if test="costPrice != null" >
        cost_price,
      </if>
      <if test="brandName != null" >
        brand_name,
      </if>
      <if test="weight != null" >
        weight,
      </if>
      <if test="skuPic != null" >
        sku_pic,
      </if>
      <if test="packageCode != null" >
        package_code,
      </if>
      <if test="packageName != null" >
        package_name,
      </if>
      <if test="packageEn != null" >
        package_en,
      </if>
      <if test="packageWeight != null" >
        package_weight,
      </if>
      <if test="packageLevelId != null" >
        package_level_id,
      </if>
      <if test="scale != null" >
        scale,
      </if>
      <if test="model != null" >
        model,
      </if>
      <if test="status != null" >
        status,
      </if>
      <if test="saleType != null" >
        sale_type,
      </if>
      <if test="salePrice != null" >
        sale_price,
      </if>
      <if test="creator != null" >
        creator,
      </if>
      <if test="modifier != null" >
        modifier,
      </if>
      <if test="remark != null" >
        remark,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="skuCode != null" >
        #{skuCode,jdbcType=VARCHAR},
      </if>
      <if test="itemCode != null" >
        #{itemCode,jdbcType=VARCHAR},
      </if>
      <if test="itemName != null" >
        #{itemName,jdbcType=VARCHAR},
      </if>
      <if test="companyNo != null" >
        #{companyNo,jdbcType=VARCHAR},
      </if>
      <if test="categoryCode != null" >
        #{categoryCode,jdbcType=VARCHAR},
      </if>
      <if test="categoryName != null" >
        #{categoryName,jdbcType=VARCHAR},
      </if>
      <if test="upc != null" >
        #{upc,jdbcType=VARCHAR},
      </if>
      <if test="saleable != null" >
        #{saleable,jdbcType=TINYINT},
      </if>
      <if test="purchasePrice != null" >
        #{purchasePrice,jdbcType=DOUBLE},
      </if>
      <if test="freight != null" >
        #{freight,jdbcType=BIGINT},
      </if>
      <if test="discount != null" >
        #{discount,jdbcType=DOUBLE},
      </if>
      <if test="logisticType != null" >
        #{logisticType,jdbcType=TINYINT},
      </if>
      <if test="costPrice != null" >
        #{costPrice,jdbcType=DOUBLE},
      </if>
      <if test="brandName != null" >
        #{brandName,jdbcType=VARCHAR},
      </if>
      <if test="weight != null" >
        #{weight,jdbcType=DOUBLE},
      </if>
      <if test="skuPic != null" >
        #{skuPic,jdbcType=VARCHAR},
      </if>
      <if test="packageCode != null" >
        #{packageCode,jdbcType=VARCHAR},
      </if>
      <if test="packageName != null" >
        #{packageName,jdbcType=VARCHAR},
      </if>
      <if test="packageEn != null" >
        #{packageEn,jdbcType=VARCHAR},
      </if>
      <if test="packageWeight != null" >
        #{packageWeight,jdbcType=DOUBLE},
      </if>
      <if test="packageLevelId != null" >
        #{packageLevelId,jdbcType=VARCHAR},
      </if>
      <if test="scale != null" >
        #{scale,jdbcType=VARCHAR},
      </if>
      <if test="model != null" >
        #{model,jdbcType=VARCHAR},
      </if>
      <if test="status != null" >
        #{status,jdbcType=INTEGER},
      </if>
      <if test="saleType != null" >
        #{saleType,jdbcType=BIT},
      </if>
      <if test="salePrice != null" >
        #{salePrice,jdbcType=DOUBLE},
      </if>
      <if test="creator != null" >
        #{creator,jdbcType=VARCHAR},
      </if>
      <if test="modifier != null" >
        #{modifier,jdbcType=VARCHAR},
      </if>
      <if test="remark != null" >
        #{remark,jdbcType=LONGVARCHAR},
      </if>
    </trim>
</insert>

    <!-- 删除sku -->
    <update id="deleteById" parameterType="java.lang.Long">
    	update item_sku
    	set is_del=1
    	where id=#{id}
    </update>
    
     <!-- 通过sku_code删除sku -->
    <update id="deleteItemSkuBySkuCode" parameterType="java.lang.String">
    	update item_sku
    	set is_del=1
    	where sku_code=#{skuCode}
    </update>


    <sql id="tableSection">item_sku</sql>

    <sql id="commonSelectSection">
        1 = 1
        <if test="itemCode != null">
            and T1.item_code = #{itemCode}
        </if>
        <if test="skuCode != null">
            and T1.sku_code = #{skuCode}
        </if>
        <if test="companyNo != null">
            and T1.company_no = #{companyNo}
        </if>
        <if test="itemName != null">
            and T1.item_name = #{itemName}
        </if>
        <if test="categoryCode != null">
            and T1.category_code = #{categoryCode}
        </if>

        <if test="upc != null">
            and T1.upc = #{upc}
        </if>
        <if test="id != null">
            and T1.id  = #{id}
        </if>
        <if test="status != null">
            and T1.status = #{status}
        </if>
        <if test=" isDel == true">
            and T1.is_del is true
        </if>
        <if test=" isDel == false">
            and T1.is_del is false
        </if>
        <if test=" isDel == null">
            and T1.is_del is false
        </if>

    </sql>


    <!--查询总条数 -->
    <select id="queryItemSku" resultType="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO" parameterType="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO">
        SELECT <include refid="Base_Column_List" />
        FROM <include refid="tableSection"/> T1
        WHERE
        <include refid="commonSelectSection"/>
    </select>

    <!--查询总条数 -->
    <select id="queryItemSkuCount" resultType="java.lang.Integer" parameterType="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO">
        SELECT COUNT(*)
        FROM <include refid="tableSection"/> T1
        WHERE
        <include refid="commonSelectSection"/>
    </select>

    <!-- -->
    <select id="queryItemSkuList" resultMap="BaseResultMap" parameterType="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO">
        SELECT  <include refid="Base_Column_List" />
        FROM <include refid="tableSection"/> T1
        WHERE
        <include refid="commonSelectSection"/>
        ORDER BY T1.id desc
    </select>

    <select id="queryItemSkusForItemThirdSale" resultType="com.wangqin.globalshop.biz1.app.dal.dataObject.ItemSkuDO" >
        SELECT
        <include refid="Base_Column_List_with_table" />, T2.quantity AS itemSkuQuantity
        FROM <include refid="tableSection"/> T1 LEFT JOIN  mall_sub_order T2 on T1.sku_code= T2.sku_code
        WHERE
        1=1
        <if test="itemCode != null">
           and T1.item_code = #{itemCode}
        </if>
        <if test="shopCode != null">
            and T2.shop_code = #{shopCode}
        </if>
        AND T2.receiver = '地址稍后'
        AND T2.quantity >1
    </select>

    <sql id="Base_Column_List_with_table" >
        T1.id, T1.sku_code, T1.item_code, T1.item_name, T1.company_no, T1.category_code, T1.category_name, T1.upc,
        T1.saleable, T1.purchase_price, T1.freight, T1.discount, T1.logistic_type, T1.cost_price, T1.brand_name,
        T1.weight, T1.sku_pic, T1.package_code, T1.package_name, T1.package_en, T1.package_weight, T1.package_level_id,
        T1.scale, model, T1.sale_type, T1.sale_price, T1.creator, T1.modifier, T1.gmt_create, T1.gmt_modify, T1.is_del
    </sql>
    
    <!-- 查询指定的upc对应的item_sku的sku_code,按公司划分-->
    <select id="querySkuCodeListByUpc"  resultType="java.lang.String">
		SELECT sku_code
		FROM `item_sku`
		<where>
		upc=#{upc}
		AND company_no=#{companyNo}
		AND is_del=0
		</where>
	</select>
	
	<!-- 查询要更新的upc是否在别的商品名下已经存在,存在则表明出现了upc重复的问题-->
    <select id="queryRecordCountByUpcCompanyNotInSameItem"  resultType="java.lang.Integer">
		SELECT count(1) 
		FROM item_sku 
		<where>
			<![CDATA[ item_code <> #{itemCode} ]]>
			AND upc=#{upc}
			AND company_no=#{companyNo}
			AND is_del=0
		</where>
	</select>

     <!-- 根据itemCode查询sku列表 -->
     <select id="querySkuListByItemCode" parameterType="java.lang.String" resultMap="BaseResultMap">
     	select  <include refid="Base_Column_List" />
     	from item_sku T1
     	where T1.item_code = #{itemCode}
     	and T1.is_del=0
     </select>
     
     
     <!-- 根据itemCode查询sku列表,包含虚拟库存、颜色、尺寸这3个不在item_sku表里面的字段-->
     <!-- 商品编辑的时候使用 -->
     <!-- TODO颜色尺寸的查询 -->
     <select id="querySkuListByItemCodeContainsVirtualInvScale" parameterType="java.lang.String" resultType="com.wangqin.globalshop.biz1.app.vo.ItemSkuQueryVO">
     	select  <include refid="Base_Column_List_For_Item_Edit" />
     	from item_sku T1 LEFT JOIN inventory inv ON T1.sku_code=inv.sku_code
     	where T1.item_code = #{itemCode}
     	and T1.is_del=0
     </select>
     
     <!-- 根据id查出该sku对应的商品在sku表里面映射了几个sku，如果只有一个，禁止删除这个sku -->
     <select id="querySkuNumberBySkuId" parameterType="java.lang.Long" resultType="java.lang.Integer">
     	SELECT count(1) 
     	FROM item_sku
     	<where>
     		item_code in 
     		(select item_code from item_sku where id=#{skuId}) 
     		AND is_del=0
     	</where>     	
     </select>
     
     <select id="querySkuCodeById" parameterType="java.lang.Long" resultType="java.lang.String">
     	SELECT sku_code
     	FROM item_sku 
     	<where>
     		id = #{id}
     	</where>
     </select>
     <select id="queryByItemCodeAndCompanyNo" parameterType="java.lang.String" resultMap="BaseResultMap">
     	SELECT  <include refid="Base_Column_List" />
     	FROM item_sku  T1
         WHERE
         T1.company_no = #{companyNo}
         AND
         T1.item_code = #{itemCode}
     </select>
     <select id="queryBySkuCodeOrUpcAndCompanyNo" parameterType="java.lang.String" resultMap="BaseResultMap">
     	SELECT  <include refid="Base_Column_List" />
     	FROM item_sku  T1
         WHERE
         T1.company_no = #{companyNo}
         AND
         ( T1.sku_code =#{code}
         OR
         T1.upc = #{code})
         AND
         T1.is_del = 0
     </select>
     
     <!-- 一键分享的商品的价格 -->
     <select id="querySalePriceByItemCode" parameterType="java.lang.String" resultType="java.lang.Double">
     	SELECT
     	MIN(sale_price)
     	FROM 
     	 item_sku
     	<where>
     	 item_code = #{itemCode}
     	 AND
     	 is_del = 0	
     	</where>
     
     </select>


    <insert id="inserBatch" parameterType="java.util.List" >
        <selectKey resultType="java.lang.Long" keyProperty="id" order="AFTER" >
            SELECT LAST_INSERT_ID()
        </selectKey>
        insert into item_sku(
                sku_code,
                item_code,
                item_name,
                company_no,
                category_code,
                category_name,
                upc,
                cost_price,
                brand_name,
                weight,
                sku_pic,
                package_code,
                package_name,
                package_en,
                package_weight,
                package_level_id,
                scale,
                creator,
                modifier,
                remark
        )VALUES
        <foreach collection="list" item="itemSku" separator=",">
            (
            #{itemSku.skuCode},
            #{itemSku.itemCode},
            #{itemSku.itemName},
            #{itemSku.companyNo},
            #{itemSku.categoryCode},
            #{itemSku.categoryName},
            #{itemSku.upc},
            #{itemSku.costPrice},
            #{itemSku.brandName},
            #{itemSku.weight},
            #{itemSku.skuPic},
            #{itemSku.packageCode},
            #{itemSku.packageName},
            #{itemSku.packageEn},
            #{itemSku.packageWeight},
            #{itemSku.packageLevelId},
            #{itemSku.scale},
            #{itemSku.creator},
            #{itemSku.modifier},
            #{itemSku.remark}
            )
        </foreach>
    </insert>
</mapper>
