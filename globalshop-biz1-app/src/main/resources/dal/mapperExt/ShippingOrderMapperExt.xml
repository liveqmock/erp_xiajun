<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wangqin.mapper.ShippingOrderMapper">
	<!-- 通用查询结果列-->
    <sql id="Base_Column_List">
		id,shipping_no as shippingNo,logistic_no as logisticNo,logistic_company as logisticCompany,subscribe_kuaidi100 as subscribeKuaidi100,status,tpl_pkg_status as tplPkgStatus,type,freight,sku_weight as skuWeight,erp_no as erpNo,erp_order_id as erpOrderId,receiver,receiver_state as receiverState,receiver_city as receiverCity,receiver_district as receiverDistrict,address_detail as addressDetail,address,telephone,postcode,remark,id_card as idCard,
		user_create as userCreate,user_modify as userModify,user_printer as userPrinter,gmt_create as gmtCreate,gmt_modify as gmtModify
	</sql>

	<select id="queryShippingOrdersCount" resultType="java.lang.Integer"  parameterType="com.wangqin.vo.ShippingOrderQueryVO">
        SELECT
        	count(1)
        FROM
            `shipping_order` T1
        <where>
        	<if test="shippingNo!=null and shippingNo!=''">
                T1.shipping_no = #{shippingNo}
            </if>
            <if test="logisticNo!=null and logisticNo!=''">
                and   T1.logistic_no = #{logisticNo}
            </if>
            <if test="logisticCompany!=null and logisticCompany!=''">
                and   T1.logistic_company = #{logisticCompany}
            </if>
            <if test="erpNo!=null and erpNo!=''">
                and   T1.erp_no LIKE concat('%',#{erpNo},'%')
            </if>
            <if test="receiver!=null and receiver!=''">
                and   T1.receiver = #{receiver}
            </if>
            <if test="telephone!=null and telephone!=''">
                and   T1.telephone = #{telephone}
            </if>
            <if test="status!=null">
                and   T1.status = #{status}
            </if>
            <if test="type!=null">
                and   T1.type = #{type}
            </if>
            <if test="salesId!=null">
             	<if test = "openId == null" >
               		and   T1.id IN (
             		SELECT a.shipping_order_id FROM erp_order a 
					LEFT JOIN outer_order b ON a.outer_order_id=b.id 
					WHERE b.sales_id=#{salesId} AND a.shipping_order_id IS NOT NULL )
               	</if>
            	<if test = "openId != null" >
               		and   T1.id IN (
             		SELECT a.shipping_order_id FROM erp_order a 
					LEFT JOIN outer_order b ON a.outer_order_id=b.id 
					WHERE (b.sales_id = #{salesId} || b.open_id=#{openId}) AND a.shipping_order_id IS NOT NULL )
               	</if>
            </if>
            <if test=" startOrderTime!=null">
				and   <![CDATA[ T1.gmt_create >= #{startOrderTime} ]]>
			</if>
			<if test=" endOrderTime!=null">
				and    <![CDATA[ T1.gmt_create <= #{endOrderTime} ]]>
			</if>
        </where>
    </select>
    
    <select id="queryShippingOrders" resultType="com.wangqin.model.ShippingOrder" parameterType="com.wangqin.vo.ShippingOrderQueryVO">
        SELECT
        	 <include refid="Base_Column_List" />
        FROM
            `shipping_order` T1
        <where>
        	<if test="shippingNo!=null and shippingNo!=''">
                T1.shipping_no = #{shippingNo}
            </if>
            <if test="logisticNo!=null and logisticNo!=''">
                and   T1.logistic_no = #{logisticNo}
            </if>
            <if test="logisticCompany!=null and logisticCompany!=''">
                and   T1.logistic_company = #{logisticCompany}
            </if>
            <if test="erpNo!=null and erpNo!=''">
                and   T1.erp_no LIKE concat('%',#{erpNo},'%')
            </if>
            <if test="receiver!=null and receiver!=''">
                and   T1.receiver = #{receiver}
            </if>
            <if test="telephone!=null and telephone!=''">
                and   T1.telephone = #{telephone}
            </if>
            <if test="status!=null">
                and   T1.status = #{status}
            </if>
            <if test="type!=null">
                and   T1.type = #{type}
            </if>
            <if test="salesId!=null">
             	<if test = "openId == null" >
               		and   T1.id IN (
             		SELECT a.shipping_order_id FROM erp_order a 
					LEFT JOIN outer_order b ON a.outer_order_id=b.id 
					WHERE b.sales_id=#{salesId} AND a.shipping_order_id IS NOT NULL)
               	</if>
            	<if test = "openId != null" >
               		and   T1.id IN (
             		SELECT a.shipping_order_id FROM erp_order a 
					LEFT JOIN outer_order b ON a.outer_order_id=b.id 
					WHERE (b.sales_id = #{salesId} || b.open_id=#{openId}) AND a.shipping_order_id IS NOT NULL)
               	</if>
            </if>
            <if test=" startOrderTime!=null">
				and   <![CDATA[ T1.gmt_create >= #{startOrderTime} ]]>
			</if>
			<if test=" endOrderTime!=null">
				and    <![CDATA[ T1.gmt_create <= #{endOrderTime} ]]>
			</if>
        </where>
          order by id desc
          	<![CDATA[ LIMIT #{firstStart},#{pageSize} ]]>
    </select>
    
    <update id="updateStatusByShippingNo" parameterType="java.lang.String">
		UPDATE shipping_order SET status=2 WHERE shipping_no=#{shippingNo}
    </update>
    <select id="queryByShippingOrderPackageTime" resultType="com.wangqin.model.ShippingOrder" parameterType="com.wangqin.vo.ShippingOrderQueryVO">
    	SELECT 
    		<include refid="Base_Column_List" />
    	FROM shipping_order 
    	WHERE 1=1
    	<if test=" startOrderTime!= null ">
			and   <![CDATA[ gmt_create >= #{startOrderTime} ]]>
		</if>
		<if test=" endOrderTime != null ">
			and    <![CDATA[ gmt_create <= #{endOrderTime} ]]>
		</if>
		<if test=" logisticCompany != null and logisticCompany !='' ">
			and    <![CDATA[ logistic_company = #{logisticCompany} ]]>
		</if> 
		ORDER BY gmt_create asc
    </select>
</mapper>