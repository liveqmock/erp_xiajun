<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wangqin.mapper.TaskDailyMapper">
  	<sql id="Base_Column_List">
    	T1.id,task_title AS taskTitle,task_desc AS taskDesc,owner_id AS ownerId,buyer_id AS buyerId,image_url AS imageUrl,task_start_time AS taskStartTime,task_end_time AS taskEndTime,T1.gmt_create AS gmtCreate,T1.gmt_modify AS gmtModify,T1.status,
        task_order_no AS taskOrderNo,T1.purchase_commission_mode as purchaseCommissionMode,T1.purchase_commission_str as
        purchaseCommissionStr,owner_name AS ownerName,buyer_name AS buyerName
    </sql>

  <select id="queryTaskCount" resultType="java.lang.Integer"  parameterType="com.wangqin.dto.TaskDailyDTO">
        SELECT
        	count(1)
        FROM
            task_daily T1
        where
     		   1=1
     		   
            <if test=" buyerId != null and buyerId != '' ">
                 and T1.buyer_id = #{buyerId}
            </if>
              <![CDATA[ and T1.task_start_time<=NOW() 
                and T1.task_end_time>= NOW()]]>
				and T1.status>=0 and T1.status!=100 
    </select>
    
    <select id="queryTaskDaily" resultType="com.wangqin.vo.TaskDailyVO" parameterType="com.wangqin.dto.TaskDailyDTO">
        SELECT
        	 id as taskId, 
        	 task_title as taskTitle,
        	 task_desc as taskDesc,
        	 image_url as imageUrl,
        	 task_start_time as time,
        	 status as status
        FROM
            task_daily T1
        where
           1=1
            <if test=" buyerId != null and buyerId != '' ">
                and T1.buyer_id = #{buyerId}
            </if>
              <![CDATA[   and T1.task_start_time<=NOW() 
                and T1.task_end_time>= NOW()]]>
			   and T1.status>=0 and T1.status != 100 
               order by T1.id asc
         	<![CDATA[ LIMIT #{firstStart},#{pageSize} ]]>
    </select>
    
    <!-- web页面按照调价查询 -->
    <select id="queryTaskDailyCount" resultType="java.lang.Integer"  parameterType="com.wangqin.vo.PurchaseQueryVO">
        SELECT
        	count(1)
        FROM
            task_daily T1 left join user t2 on T1.owner_id = t2.id 
        where
     		   1=1
             <if test=" buyerId != null ">
                 and T1.buyer_id = #{buyerId}
            </if>
            <if test=" ownerId != null ">
                 and T1.owner_id = #{ownerId}
            </if>
            <if test=" status != null ">
                 and T1.status = #{status}
            </if>
             <if test=" taskOrderNo != null and taskOrderNo != '' ">
                 and T1.task_order_no = #{taskOrderNo}
            </if>
            <if test=" taskTitle != null and taskTitle != '' ">
                  and T1.task_title LIKE concat('%',#{taskTitle},'%')
            </if>
            <if test=" taskStart1 != null ">
             	and   <![CDATA[ T1.task_start_time >= #{taskStart1} ]]>
            </if>
            <if test=" taskStart2 != null ">
           		 and    <![CDATA[ T1.task_start_time <= #{taskStart2} ]]>
            </if>
            <if test=" taskEnd1 != null ">
           		  and   <![CDATA[ T1.task_end_time >= #{taskEnd1} ]]>
            </if>
            <if test=" taskEnd2 != null ">
           		 and    <![CDATA[ T1.task_end_time <= #{taskEnd2} ]]>
            </if>
            <if test="companyId != null ">
            		and t2.company_id = #{companyId}
            </if>
             
    </select>
    
    <select id="queryTaskDailyList" resultType="com.wangqin.model.TaskDaily" parameterType="com.wangqin.vo.PurchaseQueryVO">
        SELECT
        	<include refid="Base_Column_List"/>
        FROM
            task_daily T1 left join user t2 on T1.owner_id = t2.id 
        where
           1=1
             <if test=" buyerId != null ">
                 and T1.buyer_id = #{buyerId}
            </if>
            <if test=" ownerId != null ">
                 and T1.owner_id = #{ownerId}
            </if>
            <if test=" status != null ">
                 and T1.status = #{status}
            </if>
             <if test=" taskOrderNo != null and taskOrderNo != '' ">
                 and T1.task_order_no = #{taskOrderNo}
            </if>
            <if test=" taskTitle != null and taskTitle != '' ">
                  and T1.task_title LIKE concat('%',#{taskTitle},'%')
            </if>
            <if test=" taskStart1 != null ">
             	and   <![CDATA[ T1.task_start_time >= #{taskStart1} ]]>
            </if>
            <if test=" taskStart2 != null ">
           		 and    <![CDATA[ T1.task_start_time <= #{taskStart2} ]]>
            </if>
            <if test=" taskEnd1 != null ">
           		  and   <![CDATA[ T1.task_end_time >= #{taskEnd1} ]]>
            </if>
            <if test=" taskEnd2 != null ">
           		 and    <![CDATA[ T1.task_end_time <= #{taskEnd2} ]]>
            </if>
            <if test="companyId != null ">
            		and t2.company_id = #{companyId}
            </if>
               order by T1.id desc
         	<![CDATA[ LIMIT #{firstStart},#{pageSize} ]]>
    </select>
	
	<!--  
	<update id="closeTaskDaily" >
	    UPDATE task_daily 
	    	SET status=-1 
	    WHERE id IN 
	    <foreach item="item" index="index" collection="taskDailyIdList" open="(" separator="," close=")">  
			#{item}
		</foreach> 
	</update>
	<update id="finishTaskDaily" >
	    UPDATE task_daily 
	    	SET status=2 
	    WHERE id IN 
	    <foreach item="item" index="index" collection="taskDailyIdList" open="(" separator="," close=")">  
			#{item}
		</foreach> 
	</update>
	-->
	
	
	<!-- XiaJun，更新任务状态，统一上面两个接口 -->
	<update id="updateTaskStatus" >
	    UPDATE task_daily 
	    	SET status=#{status}
	    WHERE id IN 
	    <foreach item="item" index="index" collection="idList" open="(" separator="," close=")">  
			#{item}
		</foreach> 
	</update>
	
	<!-- 任务已经开始还处于待采购或采购中状态的任务数 @Author:XiaJun -->
	<select id="countTaskStartedUnPurchased" resultType="java.lang.Integer">
	    SELECT IFNULL(count(1),0)
	    	FROM task_daily T1
	    WHERE T1.status IN 
	    <foreach item="status" index="index" collection="statusList" open="(" separator="," close=")">  
			#{status}
		</foreach> 
		AND <![CDATA[T1.task_start_time<=NOW() ]]>
	</select>
	
	<!-- 根据状态获取任务(需求把这个叫订单)数量,XiaJun -->
	<select id="countTaskNumByStatus" resultType="java.lang.Integer" parameterType="java.lang.Integer">
        SELECT IFNULL(count(1),0)
        FROM task_daily T1
        <where>
        	T1.status
        	IN 
	    	<foreach item="status" index="index" collection="statusList" open="(" separator="," close=")">  
				#{status}
			</foreach> 
        </where>
    </select>
    
    
</mapper>